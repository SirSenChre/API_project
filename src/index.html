<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Przelicznik Walut + Historia (Frankfurter API)</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="converter-card">
        <h1>Przelicznik Walut</h1>
        
        <div class="form-group">
            <label for="amount">Kwota:</label>
            <input type="number" id="amount" value="100" min="0" step="0.01">
        </div>

        <div class="form-group">
            <label>Z waluty:</label>
            <select id="fromCurrency"></select>
            <div id="fromCurrency-custom" class="custom-select-wrapper"></div>
        </div>

        <div class="swap-icon" onclick="swapCurrencies()" title="Zamień waluty">⇅</div>

        <div class="form-group">
            <label>Na walutę:</label>
            <select id="toCurrency"></select>
            <div id="toCurrency-custom" class="custom-select-wrapper"></div>
        </div>

        <div class="buttons-container">
            <button class="btn-primary" id="convertBtn" onclick="convertCurrency()">
                <span id="btnText">Przelicz teraz</span>
                <div class="loader" id="btnLoader"></div>
            </button>
            
            <button class="btn-secondary" id="historyBtn" onclick="toggleHistory()">
                <span id="histBtnText">Pokaż historię ceny</span>
            </button>
        </div>

        <div id="errorMsg" class="error"></div>

        <div class="result-container" id="resultContainer">
            <div class="result-text" id="resultValue"></div>
            <div class="rate-info" id="rateInfo"></div>
        </div>

        <div class="history-section" id="historySection">
            <h4 style="margin: 0 0 1rem 0; text-align: center; color: var(--text-color);">
                Porównanie do ceny obecnej (<span id="histLabel"></span>)
            </h4>
            <div id="histLoader" class="loader-blue"></div>
            <ul class="history-list" id="historyList"></ul>
        </div>

    </div>

    <script>
        const BASE_URL = 'https://api.frankfurter.app';

        const currencyMap = {
            "PLN": { name: "Polski złoty", flag: "pl" },
            "EUR": { name: "Euro", flag: "eu" },
            "USD": { name: "Dolar amerykański", flag: "us" },
            "CHF": { name: "Frank szwajcarski", flag: "ch" },
            "GBP": { name: "Funt szterling", flag: "gb" },
            "CZK": { name: "Korona czeska", flag: "cz" },
            "NOK": { name: "Korona norweska", flag: "no" },
            "SEK": { name: "Korona szwedzka", flag: "se" },
            "DKK": { name: "Korona duńska", flag: "dk" },
            "HUF": { name: "Forint węgierski", flag: "hu" },
            "CAD": { name: "Dolar kanadyjski", flag: "ca" },
            "AUD": { name: "Dolar australijski", flag: "au" },
            "JPY": { name: "Jen japoński", flag: "jp" },
            "CNY": { name: "Yuan chiński", flag: "cn" },
            "TRY": { name: "Lira turecka", flag: "tr" },
            "ILS": { name: "Szekel izraelski", flag: "il" },
            "BRL": { name: "Real brazylijski", flag: "br" },
            "ZAR": { name: "Rand południowoafrykański", flag: "za" },
            "RON": { name: "Lej rumuński", flag: "ro" },
            "ISK": { name: "Korona islandzka", flag: "is" },
            "BGN": { name: "Lew bułgarski", flag: "bg" },
            "NZD": { name: "Dolar nowozelandzki", flag: "nz" },
            "SGD": { name: "Dolar singapurski", flag: "sg" },
            "KRW": { name: "Won południowokoreański", flag: "kr" },
            "MXN": { name: "Peso meksykańskie", flag: "mx" },
            "INR": { name: "Rupia indyjska", flag: "in" }
        };

        const fromSelect = document.getElementById('fromCurrency');
        const toSelect = document.getElementById('toCurrency');
        const resultContainer = document.getElementById('resultContainer');
        const historySection = document.getElementById('historySection');
        const histBtnText = document.getElementById('histBtnText');
        
        // Zmienne globalne do przechowywania stanu
        let lastHistoryPair = "";
        let globalCurrentRate = 0; // Przechowujemy obecny kurs dla porównań

        function init() {
            const sortedCurrencies = Object.entries(currencyMap).sort((a, b) => a[1].name.localeCompare(b[1].name));

            sortedCurrencies.forEach(([code, data]) => {
                fromSelect.add(new Option(data.name, code));
                toSelect.add(new Option(data.name, code));
            });

            fromSelect.value = "USD";
            toSelect.value = "PLN";

            buildCustomSelect(fromSelect, 'fromCurrency-custom', sortedCurrencies);
            buildCustomSelect(toSelect, 'toCurrency-custom', sortedCurrencies);
        }

        async function convertCurrency() {
            const amount = parseFloat(document.getElementById('amount').value);
            const from = fromSelect.value;
            const to = toSelect.value;
            const errorMsg = document.getElementById('errorMsg');

            if (!amount || amount <= 0) return;

            setLoading(true);
            errorMsg.style.display = 'none';
            resultContainer.style.display = 'none';
            
            // Ukryj historię jeśli zmieniono waluty
            if (historySection.style.display === 'block' && lastHistoryPair !== `${from}-${to}`) {
                historySection.style.display = 'none';
                histBtnText.innerText = "Pokaż historię ceny";
            }

            try {
                if (from === to) {
                    globalCurrentRate = 1;
                    showResult(amount, 1, from, to);
                    setLoading(false);
                    return;
                }

                const response = await fetch(`${BASE_URL}/latest?amount=${amount}&from=${from}&to=${to}`);
                const data = await response.json();

                if (!data.rates || !data.rates[to]) throw new Error("Brak kursu");

                const resultVal = data.rates[to];
                globalCurrentRate = resultVal / amount; // Obliczamy kurs jednostkowy

                showResult(resultVal, globalCurrentRate, from, to);

            } catch (error) {
                console.error(error);
                errorMsg.innerText = "Błąd połączenia. Sprawdź internet lub spróbuj później.";
                errorMsg.style.display = 'block';
            } finally {
                setLoading(false);
            }
        }

        function showResult(value, rate, from, to) {
            const formattedValue = new Intl.NumberFormat('pl-PL', { style: 'currency', currency: to }).format(value);
            document.getElementById('resultValue').innerText = formattedValue;
            document.getElementById('rateInfo').innerText = `Kurs: 1 ${from} = ${rate.toFixed(4)} ${to}`;
            resultContainer.style.display = 'block';
        }

        async function toggleHistory() {
            const from = fromSelect.value;
            const to = toSelect.value;
            const currentPair = `${from}-${to}`;

            if (from === to) {
                alert("Wybierz dwie różne waluty.");
                return;
            }

            if (historySection.style.display === 'block' && lastHistoryPair === currentPair) {
                historySection.style.display = 'none';
                histBtnText.innerText = "Pokaż historię ceny";
                return;
            }

            historySection.style.display = 'block';
            histBtnText.innerText = "Ukryj historię ceny";
            document.getElementById('histLabel').innerText = `${from} ➝ ${to}`;
            
            // Jeśli nie mamy zapisanego obecnego kursu (bo użytkownik nie kliknął przelicz), musimy go pobrać
            if (globalCurrentRate === 0 || lastHistoryPair !== currentPair) {
                await fetchCurrentRateBeforeHistory(from, to);
            }
            
            if (lastHistoryPair !== currentPair) {
                lastHistoryPair = currentPair;
                await fetchHistoryData(from, to);
            }
        }

        // Pomocnicza funkcja do pobrania obecnego kursu (tylko dla obliczeń historycznych)
        async function fetchCurrentRateBeforeHistory(from, to) {
            try {
                const res = await fetch(`${BASE_URL}/latest?from=${from}&to=${to}`);
                const data = await res.json();
                if(data.rates && data.rates[to]) {
                    globalCurrentRate = data.rates[to];
                }
            } catch(e) { console.error("Błąd pobierania kursu bazowego"); }
        }

        async function fetchHistoryData(from, to) {
            const listEl = document.getElementById('historyList');
            const loader = document.getElementById('histLoader');
            
            listEl.innerHTML = '';
            loader.style.display = 'block';

            const today = new Date();
            const periods = [
                { label: '24 godziny temu', date: shiftDate(today, -1) },
                { label: '7 dni temu', date: shiftDate(today, -7) },
                { label: '30 dni temu', date: shiftDate(today, -30) },
                { label: '6 miesięcy temu', date: shiftDate(today, -180) },
                { label: '1 rok temu', date: shiftDate(today, -365) },
                { label: '5 lat temu', date: shiftDate(today, -365 * 5) }
            ];

            try {
                const promises = periods.map(p => {
                    let adjustedDate = adjustToWorkday(p.date);
                    const dateStr = formatDate(adjustedDate);
                    
                    const url = `${BASE_URL}/${dateStr}?from=${from}&to=${to}`;
                    return fetch(url).then(r => r.ok ? r.json() : { period: p, error: true }).then(d => ({ period: p, data: d }));
                });

                const results = await Promise.all(promises);
                loader.style.display = 'none';

                results.forEach(res => {
                    const { period, data } = res;
                    let valHtml = '<span style="color:#cbd5e1;">Brak danych</span>';
                    let trendHtml = '';

                    if (data && data.rates && data.rates[to]) {
                        const histRate = data.rates[to];
                        
                        // Obliczenia procentowe
                        // Wzór: O ile % tamta cena różni się od obecnej
                        const diffPercent = ((histRate - globalCurrentRate) / globalCurrentRate) * 100;
                        
                        valHtml = `${histRate.toFixed(4)} ${to}`;

                        if (diffPercent > 0.001) {
                            // Było drożej (wyższa cena)
                            trendHtml = `<div class="trend-tag trend-up">▲ +${diffPercent.toFixed(2)}%</div>`;
                        } else if (diffPercent < -0.001) {
                            // Było taniej (niższa cena)
                            trendHtml = `<div class="trend-tag trend-down">▼ ${diffPercent.toFixed(2)}%</div>`;
                        } else {
                            trendHtml = `<div class="trend-tag" style="background:#f1f5f9; color:#64748b">0.00%</div>`;
                        }
                    }

                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.innerHTML = `
                        <div class="hist-left">
                            <div class="hist-label">${period.label}</div>
                            <span class="hist-date">${formatDate(period.date)}</span>
                        </div>
                        <div class="hist-right">
                            <span class="hist-value">${valHtml}</span>
                            ${trendHtml}
                        </div>
                    `;
                    listEl.appendChild(li);
                });

            } catch (e) {
                loader.style.display = 'none';
                listEl.innerHTML = '<li style="text-align:center; color:red">Błąd pobierania historii</li>';
            }
        }

        /* --- HELPERY --- */
        function shiftDate(date, days) {
            const d = new Date(date);
            d.setDate(d.getDate() + days);
            return d;
        }
        
        function adjustToWorkday(date) {
            const d = new Date(date);
            const day = d.getDay();
            if (day === 0) d.setDate(d.getDate() - 2); 
            else if (day === 6) d.setDate(d.getDate() - 1);
            return d;
        }

        function formatDate(date) { return date.toISOString().split('T')[0]; }

        function setLoading(isLoading) {
            const btn = document.getElementById('convertBtn');
            const text = document.getElementById('btnText');
            const loader = document.getElementById('btnLoader');
            btn.disabled = isLoading;
            text.style.display = isLoading ? 'none' : 'block';
            loader.style.display = isLoading ? 'block' : 'none';
        }

        function swapCurrencies() {
            const temp = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = temp;
            
            refreshCustomSelect('fromCurrency-custom', fromSelect.value);
            refreshCustomSelect('toCurrency-custom', toSelect.value);
            
            resultContainer.style.display = 'none';
            historySection.style.display = 'none';
            histBtnText.innerText = "Pokaż historię ceny";
            lastHistoryPair = "";
        }

        /* --- CUSTOM SELECT BUILDER --- */
        function buildCustomSelect(nativeSelect, wrapperId, dataList) {
            const wrapper = document.getElementById(wrapperId);
            const customSelect = document.createElement("div");
            customSelect.className = "custom-select";
            
            const trigger = document.createElement("div");
            trigger.className = "custom-select-trigger";
            trigger.innerHTML = getOptionHtml(nativeSelect.value);
            
            const optionsDiv = document.createElement("div");
            optionsDiv.className = "custom-options";
            
            dataList.forEach(([code, data]) => {
                const optionDiv = document.createElement("div");
                optionDiv.className = `custom-option ${code === nativeSelect.value ? 'selected' : ''}`;
                optionDiv.dataset.value = code;
                optionDiv.innerHTML = `<img src="https://flagcdn.com/w40/${data.flag}.png" class="flag-img"> <span>${data.name} <small style="color:#94a3b8">(${code})</small></span>`;
                
                optionDiv.addEventListener("click", function() {
                    nativeSelect.value = this.dataset.value;
                    trigger.innerHTML = getOptionHtml(nativeSelect.value);
                    optionsDiv.querySelectorAll(".selected").forEach(opt => opt.classList.remove("selected"));
                    this.classList.add("selected");
                    customSelect.classList.remove("open");
                    
                    resultContainer.style.display = 'none';
                    if (historySection.style.display === 'block') {
                         historySection.style.display = 'none';
                         histBtnText.innerText = "Pokaż historię ceny";
                    }
                });
                optionsDiv.appendChild(optionDiv);
            });

            customSelect.appendChild(trigger);
            customSelect.appendChild(optionsDiv);
            wrapper.appendChild(customSelect);

            trigger.addEventListener("click", (e) => {
                e.stopPropagation();
                document.querySelectorAll('.custom-select').forEach(el => el !== customSelect && el.classList.remove('open'));
                customSelect.classList.toggle("open");
            });
        }

        function getOptionHtml(code) {
            const data = currencyMap[code];
            return `<div style="display:flex; align-items:center;"><img src="https://flagcdn.com/w40/${data.flag}.png" class="flag-img"><span>${code} - ${data.name}</span></div><div style="font-size:0.8rem; color:#94a3b8">▼</div>`;
        }

        function refreshCustomSelect(wrapperId, newValue) {
            const wrapper = document.getElementById(wrapperId);
            wrapper.querySelector('.custom-select-trigger').innerHTML = getOptionHtml(newValue);
            wrapper.querySelectorAll('.custom-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.value === newValue);
            });
        }

        window.onclick = function(e) {
            if (!e.target.closest('.custom-select')) {
                document.querySelectorAll('.custom-select').forEach(el => el.classList.remove('open'));
            }
        };

        init();
    </script>
</body>
</html>